<!DOCTYPE html>
<!-- saved from url=(0093)https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="description" content="DialogFragment的Listener在屏幕旋转后被重置的问题"><meta name="keywords" content="Listener, Fragment, Dialog, Yrom&#39;s"><link rel="alternate" href="https://www.yrom.net/atom.xml" title="Yrom&#39;s"><link rel="shortcut icon" type="image/x-icon" href="https://www.yrom.net/favicon.ico?v=2.5.1"><link rel="canonical" href="https://yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/"><link rel="stylesheet" type="text/css" href="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/style.css"><link rel="stylesheet" type="text/css" href="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/jquery.fancybox.min.css"><title>DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's</title><script async="" src="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/analytics.js"></script><script src="https://yrom.disqus.com/embed.js" data-timestamp="1504777840794"></script></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"><a href="https://www.yrom.net/" class="logo">Yrom's</a></div><div class="mobile-navbar-icon"><span></span> <span></span> <span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left"><ul class="mobile-menu-list"><a href="https://www.yrom.net/"><li class="mobile-menu-item">Home</li></a><a href="https://www.yrom.net/archives/"><li class="mobile-menu-item">Archives</li></a><a href="https://www.yrom.net/tags/"><li class="mobile-menu-item">Tags</li></a><a href="https://www.yrom.net/guestbook/"><li class="mobile-menu-item">About</li></a></ul></nav><div class="container slideout-panel slideout-panel-left" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"><a href="https://www.yrom.net/" class="logo">Yrom's</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"><a class="menu-item-link" href="https://www.yrom.net/">Home</a></li><li class="menu-item"><a class="menu-item-link" href="https://www.yrom.net/archives/">Archives</a></li><li class="menu-item"><a class="menu-item-link" href="https://www.yrom.net/tags/">Tags</a></li><li class="menu-item"><a class="menu-item-link" href="https://www.yrom.net/guestbook/">About</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">DialogFragment的Listener在屏幕旋转后被重置的问题</h1><div class="post-meta"><span class="post-time">2014-11-02</span><div class="post-category"><a href="https://www.yrom.net/categories/Android/">Android</a> <a href="https://www.yrom.net/categories/Android/Fragment/">Fragment</a></div></div></header><div class="post-toc" id="post-toc" style="position: fixed; top: 20px;"><h2 class="post-toc-title">Contents</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/#问题"><span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link active" href="https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/#原因"><span class="toc-text">原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/#解决办法"><span class="toc-text">解决办法</span></a></li></ol></div></div><div class="post-content"><h2 id="问题"><a href="https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/#问题" class="headerlink" title="问题"></a>问题</h2><p>DialogFragment 在 Activity 中创建后通过 <code>show(fm, tag)</code>，弹出 Dialog，如下面的代码所示：</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MyDialogFragment dialog = new MyDialogFragment(); // 一个自定义的 DialogFragment</div><div class="line">dialog.setButtonListener(aListener); // 一个自定义方法，设置一个监听（如某个按钮的回调）</div><div class="line">dialog.show(getFragmentManager(), "tag"); // 弹出对话框</div></pre></td></tr></tbody></table></figure><p>点击按钮可以回调 Activity 的 <code>aListener</code>，但是，如果在对话框存在的情况下旋转屏幕，再怎么点按钮<code>aLisenter</code>也不回调了？！</p><h2 id="原因"><a href="https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/#原因" class="headerlink" title="原因"></a>原因</h2><p>只要理解了Fragment 和 Activity 生命周期就会知道原因其实很简单：</p><ol><li>旋转屏幕时，<code>Activity</code>将会被重新创建。</li><li>Activity“临终”前会在<code>onSaveInstanceState()</code>中保存 <code>DialogFragment</code>的状态(<code>FragmentManagerState</code>);</li><li>“复活”后的Activity，在<code>onCreate()</code>中会根据<code>savedInstanceState</code>所给予的<code>FragmentManagerState</code>自动重新实例化<code>DialogFragment</code>，并且 <code>show()</code>出 dialog</li></ol><p>流程为：</p><pre><code>旋转屏幕--&gt;-Activity.onSaveInstanceState()--&gt;-Activity.onCreate()--&gt;- DialogFragment.show()--|
</code></pre><p>这个时候的DialogFragment所持有的<code>aListener</code>引用当然也不复存在，再点按钮自然也不会收到回调（虽然这个 dialog 看起来跟旋转屏幕之前的没什么两样，但它们是两个实例）<br><a id="more"></a></p><h2 id="解决办法"><a href="https://www.yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><ol><li>把 Listener变成 Parcelable 对象塞到 Fragment 的 Arguments 中<strong><em>（不推荐）</em></strong></li><li>在 Activity 的 onCreate() 中 通过 FragmentManager 找到重新实例化的 DialogFragment，重新设置一次 Listener</li></ol><p>至于第一种办法，主要是将 Listener 实现 Parcelbale 即可，略~~(就是懒</p><p>第二种办法：</p><pre><code>@Override
protected void onCreate(Bundle savedInstanceState) {
    // call super first !
    super.onCreate(savedInstanceState);

    // find MyDialogFragment
    if(savedInstanceState != null){
        MyDialogFragment dialog = (MyDialogFragment) getFragmentManager()
                .findFragmentByTag("dialog");
        if(dialog != null)
            dialog.setButtonListener(aListener);
    }
    // ...
    setContentView(...);
}
</code></pre><p>具体实例代码见：<a href="https://github.com/yrom/sample-dialogfragment-listener" target="_blank" rel="external">https://github.com/yrom/sample-dialogfragment-listener</a></p></div><footer class="post-footer"><div class="post-tags"><a href="https://www.yrom.net/tags/Listener/">Listener</a> <a href="https://www.yrom.net/tags/Fragment/">Fragment</a> <a href="https://www.yrom.net/tags/Dialog/">Dialog</a></div><nav class="post-nav"><a class="prev" href="https://www.yrom.net/blog/2015/01/14/apktool-decode-lollipop-style-ref-error/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">Apktool 解包资源引用偏移的问题</span> <span class="prev-text nav-mobile">Prev</span> </a><a class="next" href="https://www.yrom.net/blog/2014/08/29/eclipse-mat/"><span class="next-text nav-default">简述用 MAT 分析 Android 应用OOM</span> <span class="prev-text nav-mobile">Next</span> <i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the &lt;a href="//disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript></div></div></div></main><footer id="footer" class="footer"><div class="social-links"><a href="https://github.com/yrom" class="iconfont icon-github" title="github"></a> <a href="http://weibo.com/yrom" class="iconfont icon-weibo" title="weibo"></a> <a href="https://plus.google.com/+YromWang?rel=author" class="iconfont icon-google" title="google"></a> <a href="mailto:hi@yongrong.wang" class="iconfont icon-email" title="email"></a> <a href="https://www.linkedin.com/in/yromw" class="iconfont icon-linkedin" title="linkedin"></a> <a href="https://zhihu.com/people/yong-rong" class="iconfont icon-zhihu" title="zhihu"></a> <a href="https://www.yrom.net/atom.xml" class="iconfont icon-rss" title="rss"></a></div><div class="copyright"><span class="power-by">Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> </span><span class="theme-info">Theme - <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a> </span><span class="copyright-year">© 2011 - 2017 <span class="heart"><i class="iconfont icon-heart"></i> </span><span class="author">Yrom</span></span></div></footer><div class="back-to-top" id="back-to-top" style="display: block;"><i class="iconfont icon-up"></i></div></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://yrom.net/blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/",this.page.identifier="blog/2014/11/02/dialogfragment-retaining-listener-after-screen-rotation/",this.page.title="DialogFragment的Listener在屏幕旋转后被重置的问题"};!function(){var e=document,t=e.createElement("script");t.src="//yrom.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><script type="text/javascript" src="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/jquery.min.js"></script><script type="text/javascript" src="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/slideout.js"></script><script type="text/javascript" src="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/jquery.fancybox.min.js"></script><script type="text/javascript" src="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/even.js"></script><script type="text/javascript" src="./DialogFragment的Listener在屏幕旋转后被重置的问题 - Yrom's_files/bootstrap.js"></script><script id="google_analytics">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-37232312-1","auto"),ga("send","pageview")</script></body></html>